---
title: "teal_data reproducibility"
author: "NEST CoreDev"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{`teal_data` reproducibility}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Reproducibility of `teal_data` objects

Reproducibility is a primary function of the `qenv` class which `teal_data` inherits from. Every data modification in `teal_data` object is performed in a encapsulated environment, separate from the global environment. It's important to note that the reproducibility of this object is limited only to the data-code relationship. Other aspects such the reliability of the data source, reproducibility of the R session (including package versions), and creation and use of objects from other environments (e.g. `.GlobalEnvironment`) can't be verified properly by the `teal_data`.

## Verification status

`teal_data` objects that are instantiated empty are created as _verified_. Object can be modified only through `eval_code()` and `within()` functions to make sure that the code is saved in the object and always evaluated in the correct environment. Evaluating code in a `teal_data` object _does not_ change its verification status.

```{r, message=FALSE, error=TRUE}
library(teal.data)

my_data <- teal_data()
my_data <- within(my_data, IRIS <- iris)
my_data <- within(my_data, IRIS$id <- seq_len(nrow(iris)))
my_data # is verified
```

Find out more in the `teal_data()` documentation.

## Verification

`teal_data` objects instantiated with data and code run the risk of the code not being reproducible.
Such objects will be created in an _unverified_ state. 
To confirm that the code exactly reproduces the variables stored in the object, one must run the `verify()`.
If the verification succeeds, the object's state will be changed to _verified_, otherwise an error will be raised.
When retrieving code, unverified objects will always add a warning to the code stating that it has not passed verification.

### verified

```{r}
library(teal.data)
library(magrittr)

IRIS <- iris
IRIS$id <- seq_len(nrow(iris))

data_right <- teal_data(
  IRIS = IRIS,
  code = expression(
    IRIS <- iris,
    IRIS$id <- seq_len(nrow(iris))
  )
)
(data_right_verified <- verify(data_right)) # returns verified object
```

### unverified

```{r, message=FALSE, error=TRUE}
data_wrong <- teal_data(
  IRIS = IRIS,
  code = expression(
    iris <- iris,
    iris$id <- seq_len(nrow(iris))
  )
)
verify(data_wrong) # fails verification, raises error
```

